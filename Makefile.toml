[env]
CARGO_NET_OFFLINE = "true"

[tasks.build]
description = "Build all projects"
workspace = false
command = "cargo"
args = ["build", "--all-features", "${@}"]
dependencies = ["clean"]

[tasks.format]
description = "Format code using rustfmt"
workspace = false
command = "cargo"
args = ["fmt", "--all"]

[tasks.format-check]
description = "Verify code formatting with rustfmt"
workspace = false
command = "cargo"
args = ["fmt", "--check", "--all"]

[tasks.file]
description = "Fast local file-level validation (format + compile check)"
workspace = false
command = "cargo"
args = ["check", "--offline", "--workspace", "--all-targets", "${@}"]

[tasks.clean]
description = "Remove build artifacts"
command = "cargo"
args = ["clean", "${@}"]

[tasks.bacon]
description = "Live code checking with bacon"
workspace = false
dependencies = ["check-bacon"]
command = "bacon"
args = ["${@}", "check-all"]

[tasks.build-prod]
description = "Build optimized release binaries"
workspace = false
command = "cargo"
args = ["build", "--release", "${@}"]
dependencies = ["clean"]

[tasks.check]
description = "Quick compilation check without building"
workspace = false
command = "cargo"
args = ["check", "--workspace", "--all", "${@}"]

[tasks.architecture-check]
description = "Enforce architecture boundaries and print coupling metrics"
workspace = false
command = "bash"
args = ["scripts/check_architecture.sh"]

[tasks.fuzz]
description = "Run fuzzing tests on specified targets"
workspace = false
dependencies = ["fuzz-check-tools"]
command = "cargo"
args = ["+nightly", "fuzz", "${@}"]

[tasks.fuzz-all]
description = "Run all fuzz targets sequentially"
workspace = false
dependencies = ["fuzz-check-tools"]
command = "bash"
args = ["fuzz/run_all.sh", "${@}"]

[tasks.fuzz-check-tools]
description = "Verify fuzzing toolchain (cargo-fuzz + nightly) is installed"
workspace = false
command = "bash"
args = ["fuzz/check_tools.sh"]

[tasks.test]
description = "Run all tests with nextest"
workspace = false
dependencies = ["check-nextest"]
command = "cargo"
args = ["nextest", "run", "--workspace", "${@}"]

[tasks.clippy]
description = "Run clippy with strict rules on all targets except fuzz"
workspace = false
command = "cargo"
args = [
    "clippy",
    "--all-targets",
    "--locked",
    "--",
    "-D",
    "warnings",
    "${@}",
]

[tasks.deny]
description = "Check licenses and security advisories"
workspace = false
dependencies = ["check-deny"]
command = "cargo"
args = ["deny", "check"]

[tasks.audit]
description = "Security audit for dependencies"
workspace = false
dependencies = ["check-audit"]
command = "cargo"
args = ["audit", "${@}"]

[tasks.replay-benchmark]
description = "Run synthetic burst replay benchmark (FPGA vs kernel-bypass)"
workspace = false
command = "cargo"
args = ["run", "--release", "--", "--config", "slotstrike.toml", "--replay-benchmark", "${@}"]

[tasks.run-slotstrike]
description = "Run slotstrike and forward CLI args (example: --config /path/slotstrike.toml)"
workspace = false
command = "cargo"
args = ["run", "--release", "--", "${@}"]

[tasks.devnet-smoke]
description = "Create/fund devnet keypair and run direct-mode smoke snipe from TOML config"
workspace = false
command = "bash"
args = ["scripts/devnet_bootstrap_and_snipe.sh", "${@}"]

[tasks.devnet-auto-snipe]
description = "Alias for devnet-smoke"
workspace = false
command = "bash"
args = ["scripts/devnet_bootstrap_and_snipe.sh", "${@}"]

[tasks.service-install]
description = "Install and start systemd service via internal CLI flags"
workspace = false
command = "cargo"
args = ["run", "--release", "--", "--install-service", "${@}"]

[tasks.service-uninstall]
description = "Stop and uninstall systemd service via internal CLI flags"
workspace = false
command = "cargo"
args = ["run", "--release", "--", "--uninstall-service", "${@}"]

[tasks.check-nextest]
description = "Verify cargo-nextest is installed"
workspace = false
command = "bash"
args = [
    "-c",
    "if ! cargo nextest --version >/dev/null 2>&1; then echo 'cargo-nextest is required. Install once with: CARGO_NET_OFFLINE=false cargo install cargo-nextest' >&2; exit 1; fi",
]

[tasks.check-audit]
description = "Verify cargo-audit is installed"
workspace = false
command = "bash"
args = [
    "-c",
    "if ! cargo audit --version >/dev/null 2>&1; then echo 'cargo-audit is required. Install once with: CARGO_NET_OFFLINE=false cargo install cargo-audit' >&2; exit 1; fi",
]

[tasks.check-deny]
description = "Verify cargo-deny is installed"
workspace = false
command = "bash"
args = [
    "-c",
    "if ! cargo deny --version >/dev/null 2>&1; then echo 'cargo-deny is required. Install once with: CARGO_NET_OFFLINE=false cargo install cargo-deny' >&2; exit 1; fi",
]

[tasks.check-bacon]
description = "Verify bacon is installed"
workspace = false
command = "bash"
args = [
    "-c",
    "if ! bacon --version >/dev/null 2>&1; then echo 'bacon is required. Install once with: CARGO_NET_OFFLINE=false cargo install bacon' >&2; exit 1; fi",
]
